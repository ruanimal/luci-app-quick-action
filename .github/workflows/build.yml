name: Build IPK

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  SDK_URL: https://downloads.openwrt.org/releases/23.05.4/targets/x86/64/openwrt-sdk-23.05.4-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
  SDK_NAME: openwrt-sdk-23.05.4-x86-64_gcc-12.3.0_musl.Linux-x86_64

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: luci-app-quick-action

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison gawk gettext \
            libncurses-dev libssl-dev rsync unzip zlib1g-dev file wget libelf-dev

      - name: Cache SDK
        uses: actions/cache@v4
        id: cache-sdk
        with:
          path: ${{ env.SDK_NAME }}
          key: ${{ env.SDK_NAME }}-v3

      - name: Download SDK
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          wget -q ${{ env.SDK_URL }}
          tar -xf $(basename ${{ env.SDK_URL }})
          cd ${{ env.SDK_NAME }}
          # Update feeds to create directory structure
          ./scripts/feeds update -a
          # Create default config
          make defconfig

      - name: Build IPK
        run: |
          cd ${{ env.SDK_NAME }}

          # Copy package source to SDK feeds (create dir if not exists)
          mkdir -p feeds/luci/applications/luci-app-quick-action
          cp -r $GITHUB_WORKSPACE/luci-app-quick-action/* feeds/luci/applications/luci-app-quick-action/

          # Update feeds index and install package
          ./scripts/feeds update -i
          ./scripts/feeds install -f luci-app-quick-action

          # Ensure .config exists with package enabled
          echo "CONFIG_PACKAGE_luci-app-quick-action=m" >> .config
          make defconfig

          # Build
          make package/luci-app-quick-action/compile V=s

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          find ${{ env.SDK_NAME }}/bin/packages -name "luci-*quick-action*.ipk" -exec cp {} artifacts/ \;
          ls -la artifacts/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-quick-action-ipk
          path: artifacts/*.ipk

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*.ipk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
