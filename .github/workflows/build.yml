name: Build IPK

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  SDK_URL: https://downloads.openwrt.org/releases/23.05.4/targets/x86/64/openwrt-sdk-23.05.4-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
  SDK_NAME: openwrt-sdk-23.05.4-x86-64_gcc-12.3.0_musl.Linux-x86_64

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison gawk gettext \
            libncurses-dev libssl-dev rsync unzip zlib1g-dev file wget libelf-dev

      - name: Cache SDK
        uses: actions/cache@v4
        id: cache-sdk
        with:
          path: ${{ env.SDK_NAME }}
          key: ${{ env.SDK_NAME }}

      - name: Download SDK
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          wget -q ${{ env.SDK_URL }}
          tar -xf $(basename ${{ env.SDK_URL }})

      - name: Build IPK
        run: |
          cd ${{ env.SDK_NAME }}

          # Copy package to feeds
          mkdir -p feeds/luci/applications/luci-app-quick-action
          cp -r $GITHUB_WORKSPACE/* feeds/luci/applications/luci-app-quick-action/

          # Update feeds
          ./scripts/feeds update -i
          ./scripts/feeds install -f luci-app-quick-action

          # Build
          make package/luci-app-quick-action/compile V=s

          # Find and copy artifacts
          find bin/packages -name "luci-app-quick-action*.ipk" -exec cp {} $GITHUB_WORKSPACE/ \;

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-quick-action-ipk
          path: "*.ipk"

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: "*.ipk"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
